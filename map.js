var markersJSON = [

    {   lat: 27.4872774,
        lon: -81.4818082,
        name: "EZland Inc",
        cats: '<span class="map-marker-cat label label-primary">Real Estate</span>',
        address: '227 U.S. 27',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/Screenshot_2014-06-25_at_16.11.06/142a391b772a460d17f801e68f04e9ab.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4316/ezland-inc-sebring',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=227+U.S.+27+Sebring+FL'
    },

    {   lat: 28.0090597,
        lon: -82.1382488,
        name: "R. Jason Cronk, Esquire",
        cats: '<span class="map-marker-cat label label-primary">Attorneys &amp; Legal Services</span>',
        address: '607 S Alexander St Ste 212',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/w583h583_image/dd40ff3bcd51402f60badc3411aa9f21.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/631/r-jason-cronk-esquire-plant-city',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=607+S+Alexander+St+Ste+212+Plant+City+FL'
    },

    {   lat: 27.8935972,
        lon: -82.2710353,
        name: "Ling Express",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span><span class="map-marker-cat label label-primary">Catering &amp; Food Delivery</span>',
        address: '803 East Bloomingdale Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/6351585662518098513404/7037da893c637a5fe018cc7651d7c934.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4268/ling-express-brandon',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=803+East+Bloomingdale+Ave+Brandon+FL'
    },

    {   lat: 27.940441,
        lon: -82.266782,
        name: "China One",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span><span class="map-marker-cat label label-primary">Catering &amp; Food Delivery</span>',
        address: '1076 East Brandon Blvd Ste 107',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/0312/ac87636dff08d71bcbd849ba53d1eb1e.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4267/china-one-brandon',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1076+East+Brandon+Blvd+Ste+107+Brandon+FL'
    },

    {   lat: 26.8304093,
        lon: -81.2602802,
        name: "Drive Exr",
        cats: '<span class="map-marker-cat label label-primary">Car Rental</span>',
        address: '5446 Wayman Road',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/1501371_620297681359708_1162432196_o/16fa955fe0a8235b961bfea25f5a301f.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/7023/drive-exr-moore-haven',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=5446+Wayman+Road+Moore+Haven+FL'
    },

    {   lat: 27.960044,
        lon: -82.437805,
        name: "The Blind Tiger Cafe",
        cats: '<span class="map-marker-cat label label-primary">Coffee &amp; Tea</span>',
        address: '1901 E 7th Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/10647104_1582074058694379_4903338827500739040_n/c65ac1a4353793c8fac2a968d404b6b3.jpgoh7ef04083bc1e9c6672031b91496f2b66oe54FE1966__gda__1427309580_5dba1f6bbc2bf61de6f982b31c4d6c3f" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/8953/blind-tiger-cafe',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1901+E+7th+Ave+Tampa+FL'
    },

    {   lat: 28.0789746,
        lon: -80.6509951,
        name: "Reeds Jewelers",
        cats: '<span class="map-marker-cat label label-primary">Jewelry</span><span class="map-marker-cat label label-primary">Black Friday</span>',
        address: '1700 W New Haven Ave Ste 309A',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/tumblr_inline_n6yoerTjSS1szbwpm_1_1_1_1_1_1_1/0725a26c51ac374525b7cbf79619b304.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/6065/reeds-jewelers-melbourne',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1700+W+New+Haven+Ave+Ste+309A+Melbourne+FL'
    },

    {   lat: 27.949767,
        lon: -82.4464278,
        name: "Bamboozle Tea Lounge",
        cats: '<span class="map-marker-cat label label-primary">Restaurants &amp; Food Trucks</span>',
        address: '109 North 12th St',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/971747_474137945995297_648898125_n/f17f6f0725815f586f223e53cbf312d6.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4282/bamboozle-tea-lounge-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=109+North+12th+St+Tampa+FL'
    },

    {   lat: 28.5241431,
        lon: -81.3147606,
        name: "Dr. Murad Thakur",
        cats: '<span class="map-marker-cat label label-primary">Dentists</span>',
        address: '5480 Curry Ford Rd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/IMG_8082/305dff29ef9c91bb0e9e8185b50b555a.JPGw400h400" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/371/dr-murad-thakur-orlando',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=5480+Curry+Ford+Rd+Orlando+FL'
    },

    {   lat: 27.950575,
        lon: -82.4571776,
        name: "Wendy Pepper Creations",
        cats: '<span class="map-marker-cat label label-primary">Photography</span><span class="map-marker-cat label label-primary">Shopping</span>',
        address: 'None',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/1451551_207878606064166_1293198334_n/356ffbc0f6e517c5310b53fc9fb83171.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/6814/wendy-pepper-creations-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=loc%3A27.950575+-82.4571776'
    },

    {   lat: 28.541943,
        lon: -81.377758,
        name: "Whiskey Dicks",
        cats: '<span class="map-marker-cat label label-primary">Restaurants &amp; Food Trucks</span>',
        address: '50 E Central Blvd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/3jlQRId05F3f593NVvKxOugfweBZEhP1mFGeOYP2EtE/cfc85b114ed96fa4e7d38b9a024e55ab.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1978/whiskey-dicks-orlando',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=50+E+Central+Blvd+Orlando+FL'
    },

    {   lat: 28.0984218,
        lon: -82.3994139,
        name: "China City",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span><span class="map-marker-cat label label-primary">Catering &amp; Food Delivery</span>',
        address: '16049 Tampa Palms Blvd West',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/6352054455939815793456/0a9af1e973fc039b9f07753ac06cbbe6.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4095/china-city-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=16049+Tampa+Palms+Blvd+West+Tampa+FL'
    },

    {   lat: 28.0843199,
        lon: -80.6174673,
        name: "Aldino Cellini MD FACC PA",
        cats: '<span class="map-marker-cat label label-primary">Doctors</span>',
        address: '1601 South Apollo Blvd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/z_79/d1a53f4a91f7beb0acc8a8ba0860005f.PNG" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1980/aldino-cellini-md-facc-pa-melbourne',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1601+South+Apollo+Blvd+Melbourne+FL'
    },

    {   lat: 28.0796958,
        lon: -80.6143625,
        name: "Artful Awakenings Cosmetic Surgery",
        cats: '<span class="map-marker-cat label label-primary">Cosmetics &amp; Skin Care</span>',
        address: '400 Strawbridge Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/face-neck-surgery/d5b251919f03df2cd41f576149c25aaa.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1979/artful-awakenings-cosmetic-surgery-melbourne',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=400+Strawbridge+Ave+Melbourne+FL'
    },

    {   lat: 27.9677472,
        lon: -82.4857801,
        name: "Tampa Hackerspace",
        cats: '<span class="map-marker-cat label label-primary">Computers</span><span class="map-marker-cat label label-primary">Educational</span><span class="map-marker-cat label label-primary">Electronics</span>',
        address: '3104 North Armenia Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/logo9-300x300/6cba26c246b088b1f59918f67fd151b0.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1986/tampa-hackerspace-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=3104+North+Armenia+Ave+Tampa+FL'
    },

    {   lat: 28.06879,
        lon: -82.441448,
        name: "Island Breeze Pizzeria",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span><span class="map-marker-cat label label-primary">Pizza</span><span class="map-marker-cat label label-primary">Restaurants &amp; Food Trucks</span>',
        address: '1515 E Fletcher Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/DSC_2022/679c0af4eb6b34d712477d17ecc3e002.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4631/island-breeze-pizzeria-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1515+E+Fletcher+Ave+Tampa+FL'
    },

    {   lat: 27.945142746,
        lon: -82.5009384155,
        name: "Oregano Pizza &amp; Pasta",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span><span class="map-marker-cat label label-primary">Pizza</span><span class="map-marker-cat label label-primary">Restaurants &amp; Food Trucks</span>',
        address: '3437 W Kennedy Blvd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/1653639_797221680305798_1785440606_n/f20cb3d6390306aff3b8be59377eed4e.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4632/oregano-pizza-pasta-tampa',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=3437+W+Kennedy+Blvd+Tampa+FL'
    },

    {   lat: 28.2353692,
        lon: -82.3526255,
        name: "Hibachi Japanese Express",
        cats: '<span class="map-marker-cat label label-primary">Restaurants &amp; Food Trucks</span>',
        address: '5315 Village Market Dr',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/1555540_461520277285680_224289315_n/eb31ecc9be7fd0a153e1fabcec24d475.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4326/hibachi-japanese-express-wesley-chapel',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=5315+Village+Market+Dr+Wesley+Chapel+FL'
    },

    {   lat: 27.802262,
        lon: -80.463553,
        name: "Aldino Cellini MD FACC PA",
        cats: '<span class="map-marker-cat label label-primary">Doctors</span>',
        address: '13244 US Highway 1',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/z_80/0086198623c4574b39b2e339fd47b645.PNG" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1981/aldino-cellini-md-facc-pa-sebastian',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=13244+US+Highway+1+Sebastian+FL'
    },

    {   lat: 27.2635256,
        lon: -82.4759658,
        name: "Paneolio",
        cats: '<span class="map-marker-cat label label-primary">Food and Beverage</span>',
        address: '6208 Clark Center Ave',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/1528719_679210578765926_291622947_n/714a16c8b464e2082c0ee038048b7807.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/2362/paneolio-sarasota',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=6208+Clark+Center+Ave+Sarasota+FL'
    },

    {   lat: 28.0133862,
        lon: -82.5077593,
        name: "Integrity Car Detailing",
        cats: '<span class="map-marker-cat label label-primary">Automotive</span>',
        address: 'None',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/10428102_591571850955535_4982574807424363899_n/79cd8977018fbec0692b21d8d1f07a38.jpgohbdf25970edc9645638429becc331ac4doe54FB686A" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/8876/integrity-car-detailing',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=loc%3A28.0133862+-82.5077593'
    },

    {   lat: 27.3727497,
        lon: -82.5343112,
        name: "American Wireless Alarm, Inc",
        cats: '<span class="map-marker-cat label label-primary">Security Systems</span>',
        address: '4450 Northgate Ct',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/cache_4209382128/2a340d520ef5de2056673e5d78207127.jpgt1416601882" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/8755/american-wireless-alarm-inc-sarasota',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=4450+Northgate+Ct+Sarasota+FL'
    },

    {   lat: 28.6134268,
        lon: -81.4149817,
        name: "Frank Gay Services",
        cats: '<span class="map-marker-cat label label-primary">Electricians</span><span class="map-marker-cat label label-primary">Appliance Repair</span><span class="map-marker-cat label label-primary">Home Services</span>',
        address: '6206 Forest City Rd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/149015_546897578687949_2136325709_n/066cd1014e89b46696a11f7d28d44658.png" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/4945/frank-gay-services-orlando',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=6206+Forest+City+Rd+Orlando+FL'
    },

    {   lat: 27.3386452,
        lon: -82.5365064,
        name: "Genitrust, Inc",
        cats: '<span class="map-marker-cat label label-primary">Consulting Services</span>',
        address: '1680 Fruitville Rd Ste 335',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/10005862_241793039357500_64580900598308211_o/8b4f9c29109bff442f301b6c6d41f998.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/8314/None',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1680+Fruitville+Rd+Ste+335+Sarasota+FL'
    },

    {   lat: 27.3387011,
        lon: -82.536772,
        name: "HuB Create Space and Community",
        cats: '<span class="map-marker-cat label label-primary">Consulting Services</span><span class="map-marker-cat label label-primary">Office Space</span><span class="map-marker-cat label label-primary">Web Services</span>',
        address: '1680 Fruitville Rd',
        img: '<img width="65" src="https://airbitz.co/media/CACHE/images/business_images/3rdfloor/6d96129cb84563550ee1f751d099f9cf.jpg" class="marker-img" height="65" />',
        url: 'https://airbitz.co/biz/1115/hub-create-space-and-community-sarasota',
        directions_url: 'https://maps.google.com/maps?saddr=my+location&amp;daddr=1680+Fruitville+Rd+Sarasota+FL'
    },

{} ];

var json = markersJSON;

function getMapMarkerContent(marker, m) {
    var html = 
      '<div class="map-marker-popup">' +
        '<div class="map-marker-image"><a href="' + m.url + '">' + m.img + '</a></div>' +
        '<div class="map-marker-info">' +
          '<div class="map-marker-name">' + m.name + '</div>' +
          '<div class="map-marker-address">' + m.address + '</div>' +
          '<div class="map-marker-links"><a href="' + m.url + '">View Listing</a> | ' +
              '<a href="' + m.directions_url + '" target="_blank">Get Directions</a>' + 
          '</div>' +
        '</div>' +
        '<div class="map-marker-categories">' + m.cats + '</div>' +
      '</div>';
    return html;
}

(function() {
  var root = this;
  var AB = root.AB = {};

  AB.geoTimeout = 1000 * 60 * 60 * 1;
  AB.now = function() {
    return (new Date()).getTime();
  }
  AB.setLL = function() {
    var geo = AB.Geo.latestLocation();
    var $ll = $('#ll');
    if (geo && geo.coords) {
      var ll = geo.coords.latitude + ',' + geo.coords.longitude;
      if ($ll.length) {
        $ll.val(ll);
      } else {
        $('<input>')
          .attr('type','hidden')
          .attr('name', 'll')
          .attr('id', 'll')
          .attr('value', ll)
          .appendTo('#navbar-search');
      }
    } else {
      $ll.remove();
    }
  };
  AB.setNear = function() {
    if (AB.Geo.latestLocation()) {
      AB.setLL();
    } else {
      AB.Geo.requestLocation(function(geo) {
        AB.setLL();
        $.getJSON('/api/v1/location-suggest/?ll=' + ll).done(function(data) {
          if (data && data.near) {
            $('input.location').val(data.near);
          }
        });
      });
    }
  };
  AB.setup = function() {
    AB.setNear();

    $.ajaxSetup({
        crossDomain: false,
        beforeSend: function(xhr, settings) {
            if (!AB.Util.csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", $('meta[name="csrf-token"]').attr('content'));
            }
            xhr.setRequestHeader("Authorization", "Token 0ccff150ed4633136f04eab2d8454d928e6ff584");
        }
    });
  };
  AB.addMap = function(selector, zoom, lat, lon, markers, polygon) {
    function initialize() {
      var mapOptions = {
        center: new google.maps.LatLng(lat, lon),
        zoom: zoom,
        maxZoom: 16,
        disableDefaultUI: true,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      var bounds = new google.maps.LatLngBounds();
      var poly;
      var map = new google.maps.Map(selector[0], mapOptions);

      var infowindow = new google.maps.InfoWindow();

      $.each(markers, function(i, m) {
        if (m.lat && m.lon) {
          var loc = new google.maps.LatLng(m.lat, m.lon);
          var marker = new google.maps.Marker({
              position: loc,
              map: map,
              title: m.name,
              animation: google.maps.Animation.DROP // TODO: ran out of time - https://developers.google.com/maps/documentation/javascript/examples/marker-animations-iteration
          });

          var ref = m;
          google.maps.event.addListener(marker, 'click', function(e) {
            infowindow.setContent(getMapMarkerContent(this, ref));
            infowindow.open(map, this);
          });

          google.maps.event.addListener(marker, 'mouseover', function(e) {
            infowindow.setContent(getMapMarkerContent(this, ref));
            infowindow.open(map, this);
          });

          bounds.extend(loc);
        }
      });
      if (polygon) {
        var coords = [];
        for (var i = 0; i < polygon.length; ++i) {
          var m = polygon[i];
          if (m.lat && m.lon) {
            var loc = new google.maps.LatLng(m.lat, m.lon);
            coords.push(loc)
          }
        }
        poly = new google.maps.Polygon({
          paths: coords,
          strokeColor: '#003399',
          strokeOpacity: 0.25,
          strokeWeight: 2,
          fillColor: '#336699',
          fillOpacity: 0.15
        });
        poly.setMap(map)
      }
      if (markers && markers.length > 1) {
        map.fitBounds(bounds);
        map.panToBounds(bounds); 
      }
    }
    google.maps.event.addDomListener(window, 'load', initialize);
  };
  AB.addPlaceSearch = function(selector) {
    var loc = $('input.location').val() || '';
    var engine = new Bloodhound({
      name: 'business',
      datumTokenizer: function(d) { return d; },
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      minLength: 0,
      limit: 10,
      prefetch: {
        url: '/api/v1/autocomplete-business/?location=' + encodeURIComponent(loc),
        filter: function(data) {
          var m = $.map(data.results, function(e, i) {
              return { type: e.type, name: e.text, value: e.text };
          });
          return m;
        }
      },
      remote: {
        url: '/api/v1/autocomplete-business/?term=%QUERY',
        replace: function (url, uriEncodedQuery) {
          q = url.replace(/%QUERY/, uriEncodedQuery)
          if ($('input.location').val()) {
              q += "&location=" + encodeURIComponent(loc);
          }
          return q;
        },
        filter: function(data) {
          return $.map(data.results, function(e, i) {
              return { type: e.type, name: e.text, value: e.text, id: e.bizId };
          });
        },
        rateLimitWait: 100
      }
    });
    engine.initialize();
    selector.typeahead({
      minLength: 0,
      hint: false,
      highlight: true
    }, {
      minLength: 0,
      displaykey: 'name',
      name: 'business',
      source: engine.ttAdapter(),
      template: function(datum) {
          return '<p>' + datum.name + '</p>';
      }
    });
    selector.on('typeahead:selected', function (object, datum) {
      if (datum.type === 'business' && datum.id) {
        location.href = 'https://airbitz.co/biz/' + datum.id;
      }
    });
    selector.click(function() {
      $(this).select();
    });
  };
  AB.addLocationSearch = function(selector, locSelector) {
      var values = ['On the Web', 'Current Location'];
      var defaultString = '';
      $.each(values, function(val) {
        return defaultString += val + ' ';
      });
      var local = new Bloodhound({
        datumTokenizer: function(d) { return defaultString.split(/\s+/); },
        queryTokenizer: function(d) { return defaultString.split(/\s+/); },
        local: $.map(values, function(val) {
          return { text: val, value: val };
        })
      });
      local.initialize();
      var locFilter = function(data) {
        return data.results.map(function(s, i) {
            return { text: s, value: s };
        });
      };

      var engine = new Bloodhound({
        datumTokenizer: function(d) { return d; }, 
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        minLength: 0,
        prefetch: {
          url: '/api/v1/autocomplete-location/',
          filter: locFilter
        },
        remote: {
          url: '/api/v1/autocomplete-location/?term=%QUERY',
          filter: locFilter,
          rateLimitWait: 100
        }
      });
      engine.initialize();
      selector.typeahead({
        minLength: 0,
        hint: false,
        highlight: true
      }, [ {
        displaykey: 'text',
        name: 'always',
        source: local.ttAdapter(),
        templates: function(datum) {
          return datum.text;
        }
      }, {
        displaykey: 'text',
        name: 'location',
        source: engine.ttAdapter(),
        templates: function(datum) {
          return datum.text;
        }
      }]);
      var updatePlace = function() {
        $('input.term').typeahead('destroy');
        AB.addPlaceSearch($('input.term'));
      };
      selector.on('typeahead:selected', function (object, datum) {
        $(this).val(datum.text);
        updatePlace();
      });
      selector.click(function() {
        $(this).select();
      });
      selector.change(updatePlace);
      selector.blur(updatePlace);
  };
  var Geo = AB.Geo = { 
    latestLocation: function() {
      var cookie = Util.getCookie('geo');
      try {
        var geo = JSON.parse(cookie);
      } catch (e) {
        console.log(e);
      }   
      return geo;
    },  
    requestLocation: function(cb) {
      var now = new Date();
      var geo = this.latestLocation();
      if (geo) {
        try {
            var then = new Date(geo.timestamp).getTime();
            if (now - then < AB.geoTimeout) {
                return;
            }   
        } catch (e) {
            console.log(e);
        }   
      }   
      var that = this;
      var now = AB.now();
      var then = AB.Util.getCookie('geo_timestamp');
      if (navigator.geolocation 
          && (then == null || now - then > AB.geoTimeout)) {
        var options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        };
        AB.Util.setCookie('geo_timestamp', AB.now(), 1); 
        navigator.geolocation.getCurrentPosition(function(geo) {
          that.postPosition(geo, cb);
        }, function(err) { }, options);
      }   
    },  
    postPosition: function(geo, cb) {
      Util.setCookie('geo', JSON.stringify(geo), 1); 
      cb(geo);
    }   
  };
  var Util = AB.Util = {
      csrfSafeMethod: function(method) {
          return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
      },
      setCookie: function(c_name, value, exdays) {
          var exdate = new Date();
          exdate.setDate(exdate.getDate() + exdays);
          var c_value = escape(value) + ((exdays===null) ? "" : "; expires="+exdate.toUTCString());
          document.cookie=c_name + "=" + c_value;
      },
      getCookie: function(c_name) {
          var c_value = document.cookie;
          var c_start = c_value.indexOf(" " + c_name + "=");
          if (c_start == -1) {
              c_start = c_value.indexOf(c_name + "=");
          }
          if (c_start == -1) {
              c_value = null;
          } else {
              c_start = c_value.indexOf("=", c_start) + 1;
              var c_end = c_value.indexOf(";", c_start);
              if (c_end == -1) {
              c_end = c_value.length;
              }
              c_value = unescape(c_value.substring(c_start,c_end));
          }
          return c_value;
      }
  };


var polygon = [

    {} ];
    AB.setup();
//    AB.addLocationSearch($('input.location'));
//    AB.addPlaceSearch($('input.term'));
    AB.addMap($('#map'), 5, 27.6648274, -81.5157535, json, polygon);

}).call(this);
